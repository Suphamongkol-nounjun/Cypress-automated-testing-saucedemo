name: üõ°Ô∏è ZAP Scan Juice Shop

on:
  workflow_dispatch: # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô workflow ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Actions ‡πÉ‡∏ô GitHub
  push:
    branches:
      - main # ‡∏´‡∏£‡∏∑‡∏≠ branch ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

jobs:
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: üìö Checkout code
        uses: actions/checkout@v4

      - name: üìÅ Create ZAP Configuration and Report Directories
        run: |
          mkdir -p zap-config
          mkdir -p zap-reports

      - name: üìù Create ZAP Automation Plan
        shell: bash
        run: |
          cat <<EOF > zap-config/automation_plan.yaml
          # ZAP Automation Framework Plan
          # https://www.zaproxy.org/docs/automate/automation-framework/

          env:
            contexts: # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î context ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
              - name: 'Juice Shop Target'
                urls:
                  - 'http://localhost:3000' # URL ‡∏Ç‡∏≠‡∏á Juice Shop
                includePaths: # ‡∏£‡∏∞‡∏ö‡∏∏ path ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (regex)
                  - 'http://localhost:3000.*'
                # excludePaths: # (Optional) ‡∏£‡∏∞‡∏ö‡∏∏ path ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (regex)
                #   - 'http://localhost:3000/rest/user/logout.*'
            parameters:
              failOnError: true       # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏≤‡∏Å‡∏°‡∏µ error
              failOnWarning: false    # ‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÅ‡∏Ñ‡πà warning
              progressToStdout: true  # ‡πÅ‡∏™‡∏î‡∏á progress ‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á stdout

          jobs:
            # Job: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Add-ons (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ rules ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
            - type: addOns
              parameters:
                updateAddOns: true

            # Job: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Passive Scan
            - type: passiveScan-config
              parameters:
                maxAlertsPerRule: 10
                scanOnlyInScope: true # ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ URL ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô context

            # Job: Spider (Crawl ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ URLs)
            - type: spider
              name: spiderStandard
              parameters:
                context: 'Juice Shop Target'
                url: 'http://localhost:3000'
                maxDuration: 5      # ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ spider (‡∏ô‡∏≤‡∏ó‡∏µ)
                maxDepth: 5         # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ crawl
                acceptCookies: true

            # Job: AJAX Spider (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ JavaScript ‡∏°‡∏≤‡∏Å) - Optional
            - type: ajaxSpider
              name: spiderAjax
              parameters:
                context: 'Juice Shop Target'
                url: 'http://localhost:3000'
                maxDuration: 5      # ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ô‡∏≤‡∏ó‡∏µ)
                # browserId: firefox # (Optional) ‡∏£‡∏∞‡∏ö‡∏∏ browser ID ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
              # dependsOn: # (Optional) ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ job ‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á job ‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏ä‡πà‡∏ô spiderStandard
              #   - spiderStandard

            # Job: Active Scan (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏´‡∏ß‡πà‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∏‡∏Å)
            - type: activeScan
              name: activeScanDefaultPolicy
              parameters:
                context: 'Juice Shop Target'
                policy: 'Default Policy' # ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á custom policy ‡πÑ‡∏î‡πâ)
                maxScanDurationInMins: 30 # ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Active Scan (‡∏ô‡∏≤‡∏ó‡∏µ)
              # dependsOn:
              #   - spiderAjax # ‡∏´‡∏£‡∏∑‡∏≠ spiderStandard ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ajaxSpider

            # --- Report Generation Jobs ---
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ

            - type: report
              name: reportTraditionalHTML
              parameters:
                template: traditional-html # Template ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML ‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°
                reportDir: /zap/wrk/reports/ # Directory ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô container ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö report
                reportFile: traditional-html-report # ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (ZAP ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° .html ‡πÄ‡∏≠‡∏á)
                reportTitle: "ZAP Traditional HTML Report for Juice Shop"
                reportDescription: "Generated by ZAP Automation Framework"
                risks: # ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                  - High
                  - Medium
                  - Low
                  - Informational
                confidences: # ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à
                  - High
                  - Medium
                  - Low
                  - User Confirmed

            - type: report
              name: reportModernHTML
              parameters:
                template: modern # Template ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡∏Å‡∏ß‡πà‡∏≤)
                reportDir: /zap/wrk/reports/
                reportFile: modern-html-report
                reportTitle: "ZAP Modern HTML Report for Juice Shop"

            - type: report
              name: reportXML
              parameters:
                template: traditional-xml # Template ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô XML
                reportDir: /zap/wrk/reports/
                reportFile: traditional-xml-report

            - type: report
              name: reportJSON
              parameters:
                template: traditional-json # Template ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô JSON
                reportDir: /zap/wrk/reports/
                reportFile: traditional-json-report

            - type: report
              name: reportMarkdown
              parameters:
                template: traditional-markdown # Template ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Markdown
                reportDir: /zap/wrk/reports/
                reportFile: traditional-markdown-report

            # (Optional) ‡πÄ‡∏û‡∏¥‡πà‡∏° Job ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Report Template ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà ZAP ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
            # ‡πÄ‡∏ä‡πà‡∏ô 'high-level-report', 'alert-count-summary', 'risk-confidence-html'
            # - type: report
            #   parameters:
            #     template: high-level-report
            #     reportDir: /zap/wrk/reports/
            #     reportFile: high-level-summary-report
          EOF
          echo "ZAP Automation Plan created at zap-config/automation_plan.yaml"

      - name: üöÄ Start OWASP Juice Shop
        run: |
          docker pull bkimminich/juice-shop
          docker run -d --rm --name juice-shop -p 3000:3000 bkimminich/juice-shop
          echo "Juice Shop container starting..."

          echo "Waiting for Juice Shop to be fully accessible..."
          RETRY_COUNT=0
          MAX_RETRIES=15 # ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏≠‡∏á (15 * 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ = 150 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout)
          WAIT_SECONDS=10
          until curl --output /dev/null --silent --head --fail http://localhost:3000; do
            if [ \${RETRY_COUNT} -ge \${MAX_RETRIES} ]; then
              echo "‚ùå Juice Shop failed to start or is not accessible after \${MAX_RETRIES} retries."
              echo "--- Juice Shop Docker Logs ---"
              docker logs juice-shop
              echo "-----------------------------"
              exit 1
            fi
            RETRY_COUNT=\$((RETRY_COUNT+1))
            echo "Waiting for Juice Shop... (Attempt \${RETRY_COUNT}/\${MAX_RETRIES})"
            sleep \${WAIT_SECONDS}
          done
          echo "‚úÖ Juice Shop started successfully and is accessible at http://localhost:3000"

      - name: üîé Run OWASP ZAP Scan with Automation Framework
        run: |
          ZAP_CONFIG_DIR="\$(pwd)/zap-config"      # Directory ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå plan.yaml ‡∏ö‡∏ô runner
          ZAP_REPORTS_DIR="\$(pwd)/zap-reports"   # Directory ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö reports ‡∏ö‡∏ô runner

          echo "Starting ZAP Scan using Automation Framework..."
          # ‡πÉ‡∏ä‡πâ owasp/zap2docker-stable image
          # Mount ZAP configuration directory (read-only)
          # Mount ZAP reports output directory (read-write)
          # --network="host" ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ ZAP container ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á localhost:3000 (Juice Shop) ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
          docker run \
            --network="host" \
            -v "\${ZAP_CONFIG_DIR}":/zap/config/:ro \
            -v "\${ZAP_REPORTS_DIR}":/zap/wrk/reports/:rw \
            --rm owasp/zap2docker-stable zap.sh -cmd \
            -autorun /zap/config/automation_plan.yaml

          echo "‚úÖ ZAP Scan Finished. Reports should be in \${ZAP_REPORTS_DIR}"

      - name: üìä List Generated Reports
        run: |
          echo "Contents of zap-reports directory:"
          ls -lR zap-reports
          if [ -z "\$(ls -A zap-reports)" ]; then
            echo "‚ö†Ô∏è Warning: No reports found in zap-reports directory."
          else
            echo "--- Checking main report files ---"
            for f in zap-reports/*.*; do
              if [ -s "\$f" ]; then
                echo "  ‚úÖ \$f exists and is not empty."
              else
                echo "  ‚ö†Ô∏è Warning: \$f is missing or empty."
              fi
            done
          fi


      - name: üì§ Upload ZAP Scan Reports
        uses: actions/upload-artifact@v4
        if: always() # ‡∏£‡∏±‡∏ô step ‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡∏ß‡πà‡∏≤ step ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ report ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        with:
          name: zap-scan-reports
          path: zap-reports/ # Path ‡πÑ‡∏õ‡∏¢‡∏±‡∏á directory ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö report
          retention-days: 7  # (Optional) ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö artifact ‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ

      - name: üõë Stop OWASP Juice Shop
        if: always() # ‡∏£‡∏±‡∏ô step ‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ cleanup
        run: |
          echo "Stopping Juice Shop container..."
          docker stop juice-shop || echo "Juice Shop container not found or already stopped."